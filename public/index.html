<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkyIQ | AI Voice Solutions</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, system-ui, sans-serif;
            background: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .main-content {
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-bottom: 1px solid #e2e8f0;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.08);
            position: sticky;
            top: 0;
            z-index: 100;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1;
            min-width: 0;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }
        
        .logo-icon {
            width: 36px;
            height: 36px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:%234f46e5;stop-opacity:1" /><stop offset="100%" style="stop-color:%2306b6d4;stop-opacity:1" /></linearGradient></defs><path d="M20 25 Q20 15 30 15 L70 15 Q80 15 80 25 L80 45 Q80 55 70 55 L55 55 L50 65 L45 55 L30 55 Q20 55 20 45 Z" fill="url(%23grad1)" stroke="white" stroke-width="2"/><path d="M30 70 Q30 60 40 60 L75 60 Q85 60 85 70 L85 85 Q85 95 75 95 L40 95 Q30 95 30 85 Z" fill="url(%23grad1)" opacity="0.7"/><path d="M35 25 L75 25 M35 35 L65 35 M35 45 L70 45" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>') center/contain no-repeat;
            border-radius: 10px;
            filter: drop-shadow(0 2px 4px rgba(79, 70, 229, 0.2));
        }
        
        .logo-text {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #4f46e5, #06b6d4);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1e293b;
            letter-spacing: -0.025em;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .profile-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.75rem;
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.3);
        }
        
        .content-area {
            padding: 16px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 20px;
            margin-bottom: 20px;
            color: #15803d;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        .section-card {
            background: linear-gradient(135deg, #ffffff 0%, #fafbff 100%);
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
            margin-bottom: 24px;
            overflow: hidden;
        }
        
        .section-header {
            padding: 20px 16px;
            border-bottom: 1px solid #e2e8f0;
            background: linear-gradient(135deg, #fafbff 0%, #f1f5f9 100%);
        }
        
        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 4px;
            color: #1e293b;
            letter-spacing: -0.025em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-subtitle {
            color: #64748b;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .section-content {
            padding: 20px 16px;
        }
        
        .phone-input-group {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        .phone-input {
            flex: 1;
            min-width: 250px;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            transition: all 0.2s ease;
            background: #ffffff;
        }
        
        .phone-input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .prompt-editor {
            width: 100%;
            min-height: 180px;
            padding: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 0.875rem;
            font-family: system-ui, -apple-system, sans-serif;
            transition: all 0.2s ease;
            background: #ffffff;
            resize: vertical;
            line-height: 1.5;
        }

        .prompt-editor:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .prompt-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .prompt-status, .call-status {
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 0.875rem;
            font-weight: 500;
            display: none;
        }
        
        .call-btn, .btn {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            min-height: 48px;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
            justify-content: center;
        }

        .call-btn {
            width: 100%;
        }
        
        .btn:hover, .call-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(79, 70, 229, 0.4);
        }
        
        .btn:active, .call-btn:active {
            transform: scale(0.98);
        }
        
        .btn:disabled, .call-btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn.secondary {
            background: white;
            color: #4f46e5;
            border: 2px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .btn.secondary:hover {
            border-color: #4f46e5;
            background: #f8faff;
        }
        
        .call-status.success, .prompt-status.success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
            display: block;
        }
        
        .call-status.error, .prompt-status.error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
            display: block;
        }
        
        .call-status.loading, .prompt-status.loading {
            background: #dbeafe;
            color: #1d4ed8;
            border: 1px solid #bfdbfe;
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #fafbff 100%);
            padding: 16px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-align: center;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #4f46e5, #06b6d4);
        }
        
        .stat-value {
            font-size: 1.75rem;
            font-weight: 800;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 4px;
            line-height: 1.1;
        }
        
        .stat-label {
            color: #64748b;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .controls {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        .call-cards {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .call-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .call-card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .call-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
            gap: 12px;
        }
        
        .call-phone {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 0.9rem;
            font-weight: 600;
            color: #4f46e5;
            flex-shrink: 0;
        }
        
        .call-datetime {
            text-align: right;
            font-size: 0.75rem;
            color: #64748b;
            line-height: 1.3;
        }
        
        .call-date {
            font-weight: 600;
        }
        
        .call-time {
            color: #94a3b8;
        }
        
        .call-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 6px;
            font-size: 0.75rem;
        }
        
        .call-duration {
            color: #475569;
            font-weight: 500;
        }
        
        .call-type-badge {
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.6rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .call-type-inbound {
            background: #dbeafe;
            color: #1d4ed8;
        }
        
        .call-type-outbound {
            background: #f3e8ff;
            color: #7c3aed;
        }
        
        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.6rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-completed {
            background: #dcfce7;
            color: #166534;
        }
        
        .status-failed {
            background: #fef2f2;
            color: #dc2626;
        }
        
        .status-initiated {
            background: #e0f2fe;
            color: #0369a1;
        }
        
        .call-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 8px;
        }
        
        .transcript-btn {
            background: none;
            border: 1px solid #e2e8f0;
            color: #4f46e5;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .transcript-btn:hover {
            background: #f8fafc;
            border-color: #4f46e5;
        }
        
        .transcript-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }
        
        .empty-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
            opacity: 0.5;
        }
        
        .empty-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 6px;
            color: #475569;
        }
        
        .empty-subtitle {
            margin-bottom: 16px;
            font-size: 0.875rem;
        }
        
        .webhook-url {
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 8px 12px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 0.7rem;
            color: #4f46e5;
            word-break: break-all;
            max-width: 100%;
            margin: 0 auto;
        }
        
        .notification {
            position: fixed;
            top: 24px;
            right: 24px;
            background: #22c55e;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            font-weight: 500;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            background: #dc2626;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }
        
        .transcript-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 20px;
            max-width: calc(100vw - 32px);
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 16px;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
            flex: 1;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
            padding: 8px;
            min-height: 44px;
            min-width: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            flex-shrink: 0;
        }
        
        .close-btn:hover {
            background: #f1f5f9;
        }
        
        .transcript-content {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            font-family: system-ui, -apple-system, sans-serif;
            font-size: 0.875rem;
            line-height: 1.6;
            white-space: pre-wrap;
            color: #475569;
            max-height: 60vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .prompt-templates {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .template-btn {
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            color: #64748b;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .template-btn:hover {
            background: #e2e8f0;
            color: #4f46e5;
        }
        
        /* Media Queries */
        @media (min-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .content-area {
                padding: 24px;
            }
            
            .header {
                padding: 20px 32px;
            }
            
            .logo-icon {
                width: 44px;
                height: 44px;
            }
            
            .logo-text {
                font-size: 1.75rem;
            }
            
            .header-title {
                font-size: 1.5rem;
            }
            
            .profile-avatar {
                width: 36px;
                height: 36px;
                font-size: 0.875rem;
            }
            
            .phone-input-group {
                flex-wrap: nowrap;
            }
        }
        
        @media (max-width: 480px) {
            .header {
                flex-direction: column;
                align-items: stretch;
                gap: 16px;
                padding: 16px;
            }
            
            .header-left {
                justify-content: center;
            }
            
            .user-profile {
                justify-content: center;
            }
            
            .logo-text {
                font-size: 1.25rem;
            }
            
            .header-title {
                font-size: 1rem;
                text-align: center;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                padding: 14px 16px;
            }
            
            .phone-input-group {
                flex-direction: column;
            }
            
            .phone-input {
                min-width: 100%;
            }

            .prompt-actions {
                flex-direction: column;
            }

            .prompt-templates {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="main-content">
        <div class="header">
            <div class="header-left">
                <div class="logo">
                    <div class="logo-icon"></div>
                    <div class="logo-text" id="appName">SkyIQ</div>
                </div>
                <div class="header-title" id="companyName">Inbound Dashboard</div>
            </div>
            <div class="user-profile">
                <div class="profile-avatar" id="userInitials">--</div>
            </div>
        </div>

        <div class="content-area">
            <div class="connection-status">
                <div class="status-dot"></div>
                <span id="connectionStatus">Connected</span>
            </div>

            <!-- Outbound Call Section -->
            <div class="section-card">
                <div class="section-header">
                    <div class="section-title">
                        üìû Make Call
                    </div>
                    <div class="section-subtitle">Make individual calls directly from your dashboard</div>
                </div>
                <div class="section-content">
                    <div class="phone-input-group">
                        <input 
                            type="tel" 
                            id="phoneInput" 
                            class="phone-input" 
                            placeholder="Enter phone number (e.g., +1-555-123-4567)"
                            maxlength="20"
                        >
                        <button id="callButton" class="call-btn" onclick="initiateCall()">
                            üìû Start Call
                        </button>
                    </div>
                    <div id="callStatus" class="call-status"></div>
                </div>
            </div>

            <!-- Stats Section -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalCalls">0</div>
                    <div class="stat-label">Total Calls</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="inboundCalls">0</div>
                    <div class="stat-label">Inbound Calls</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="transcriptCount">0</div>
                    <div class="stat-label">With Transcripts</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="lastUpdate">Never</div>
                    <div class="stat-label">Last Update</div>
                </div>
            </div>

            <div class="controls">
                <button class="btn" onclick="refreshData()">Refresh Data</button>
                <button class="btn secondary" onclick="viewAllCalls()">View All Calls</button>
            </div>

            <!-- Compact Call Log -->
            <div class="section-card">
                <div class="section-header">
                    <div class="section-title">Recent Calls</div>
                    <div class="section-subtitle">Latest conversation activity</div>
                </div>
                
                <div id="callHistory">
                    <div class="empty-state">
                        <div class="empty-icon">üìû</div>
                        <div class="empty-title">Waiting for calls</div>
                        <div class="empty-subtitle">Your live call data will appear here</div>
                        <div class="webhook-url" id="webhookUrl">Loading webhook URL...</div>
                    </div>
                </div>
            </div>

            <!-- Prompt Editor Section -->
            <div class="section-card">
                <div class="section-header">
                    <div class="section-title">
                        ‚úèÔ∏è Edit AI Agent Prompt
                    </div>
                    <div class="section-subtitle">Customize how your AI agent responds to calls</div>
                </div>
                <div class="section-content">
                    <div class="prompt-templates">
                        <button class="template-btn" onclick="loadTemplate('sales')">üéØ Sales</button>
                        <button class="template-btn" onclick="loadTemplate('support')">üõ†Ô∏è Support</button>
                        <button class="template-btn" onclick="loadTemplate('appointment')">üìÖ Appointments</button>
                        <button class="template-btn" onclick="loadTemplate('receptionist')">üìã Receptionist</button>
                    </div>
                    
                    <textarea 
                        id="promptEditor" 
                        class="prompt-editor"
                        placeholder="Enter your AI agent's instructions here. This will determine how the agent behaves during calls..."
                    ></textarea>
                    
                    <div class="prompt-actions">
                        <button id="savePromptBtn" class="btn" onclick="savePrompt()">
                            üíæ Save Prompt
                        </button>
                        <button class="btn secondary" onclick="loadCurrentPrompt()">
                            üîÑ Reload Current
                        </button>
                    </div>
                    
                    <div id="promptStatus" class="prompt-status"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="transcriptModal" class="transcript-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Call Transcript</div>
                <button class="close-btn" onclick="closeTranscriptModal()">&times;</button>
            </div>
            <div class="transcript-content" id="modalTranscript">
                No transcript available
            </div>
        </div>
    </div>

    <div id="notification" class="notification">
        New call received
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Configuration object
        const config = {
            appName: 'SkyIQ',
            companyName: 'Inbound Dashboard',
            userInitials: 'RP',
            maxCallsToShow: 10,
            autoRefreshInterval: 30000,
            socketEnabled: true
        };

        // Global variables
        let calls = [];
        let currentPrompt = '';

        // Prompt templates
        const promptTemplates = {
            sales: `You are a professional sales agent for our company. Your goal is to:
- Greet callers warmly and professionally
- Listen to their needs and understand their pain points
- Present our solutions in a compelling way
- Handle objections with empathy and expertise
- Guide the conversation toward scheduling a demo or next steps
- Always be helpful, knowledgeable, and customer-focused

Keep responses concise and conversational. Ask qualifying questions to understand their business needs.`,

            support: `You are a helpful customer support agent. Your primary objectives are to:
- Provide excellent customer service with patience and empathy
- Listen carefully to customer issues and concerns
- Offer clear, step-by-step solutions
- Escalate complex technical issues when appropriate
- Ensure customer satisfaction before ending the call
- Document any issues for follow-up

Always remain calm and professional, even with frustrated customers. Focus on resolving their problems efficiently.`,

            appointment: `You are an appointment scheduling specialist. Your role is to:
- Greet callers professionally and understand their scheduling needs
- Check availability and offer suitable time slots
- Collect necessary information for the appointment
- Confirm all details including date, time, and contact information
- Send confirmation and any preparation instructions
- Handle rescheduling requests professionally

Be efficient but thorough. Always double-check appointment details before confirming.`,

            receptionist: `You are a friendly and professional receptionist. Your responsibilities include:
- Greeting callers with warmth and professionalism
- Directing calls to the appropriate department or person
- Taking detailed messages when needed
- Providing basic company information and hours
- Handling general inquiries politely
- Maintaining a helpful and courteous tone

Always ask for the caller's name and reason for calling to provide the best assistance.`
        };

        // Socket connection
        let socket;
        if (config.socketEnabled && typeof io !== 'undefined') {
            socket = io();
            
            socket.on('connect', () => {
                updateConnectionStatus('Connected', '#22c55e');
            });

            socket.on('disconnect', () => {
                updateConnectionStatus('Disconnected', '#dc2626');
            });

            socket.on('callHistory', (history) => {
                calls = history;
                renderCallHistory();
            });

            socket.on('newCall', (callData) => {
                calls.unshift(callData);
                renderCallHistory();
                showNotification(`${callData.call_type === 'outbound' ? 'Outbound' : 'New'} call ${callData.call_type === 'outbound' ? 'initiated' : 'received'}`);
                updateStats();
            });

            socket.on('updateCall', (callData) => {
                const index = calls.findIndex(call => call.id === callData.id);
                if (index >= 0) {
                    calls[index] = callData;
                    renderCallHistory();
                    updateStats();
                }
            });
        }

        // DOM elements
        const callHistory = document.getElementById('callHistory');
        const totalCalls = document.getElementById('totalCalls');
        const inboundCalls = document.getElementById('inboundCalls');
        const transcriptCount = document.getElementById('transcriptCount');
        const lastUpdate = document.getElementById('lastUpdate');
        const connectionStatus = document.getElementById('connectionStatus');
        const notification = document.getElementById('notification');
        const transcriptModal = document.getElementById('transcriptModal');
        const modalTranscript = document.getElementById('modalTranscript');
        const modalTitle = document.getElementById('modalTitle');
        const phoneInput = document.getElementById('phoneInput');
        const callButton = document.getElementById('callButton');
        const callStatus = document.getElementById('callStatus');
        const promptEditor = document.getElementById('promptEditor');
        const savePromptBtn = document.getElementById('savePromptBtn');
        const promptStatus = document.getElementById('promptStatus');

        // Initialize app
        function initializeApp() {
            document.getElementById('appName').textContent = config.appName;
            document.getElementById('companyName').textContent = config.companyName;
            document.getElementById('userInitials').textContent = config.userInitials;
            
            const webhookUrl = document.getElementById('webhookUrl');
            webhookUrl.textContent = `${window.location.origin}/webhook`;
            
            updateStats();
            loadCurrentPrompt();
        }

           async function savePrompt() {
    const prompt = promptEditor.value.trim();
    
    if (!prompt) {
        showPromptStatus('Please enter a prompt before saving', 'error');
        return;
    }

    try {
        savePromptBtn.disabled = true;
        savePromptBtn.textContent = 'üíæ Saving...';
        showPromptStatus('Saving prompt...', 'loading');

        // Extract name and company for first message
        let firstMessage = '';
        const nameMatch = prompt.match(/(?:named|name is|you are)\s+(\w+)/i);
        const companyMatch = prompt.match(/(?:work for|from|at)\s+([A-Za-z\s']+?)(?:\s+and|\.|$)/i);
        
        if (nameMatch) {
            let agentName = nameMatch[1];
            let company = '';
            
            if (companyMatch) {
                company = ` from ${companyMatch[1].trim()}`;
            }
            
            firstMessage = `Hello! This is ${agentName}${company}. How can I help you today?`;
        }

        const response = await fetch('/api/prompt', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                system_prompt: prompt, 
                first_message: firstMessage 
            })
        });

        const result = await response.json();

        if (result.success) {
            currentPrompt = prompt;
            showPromptStatus('Prompt saved successfully!', 'success');
            showNotification('AI agent prompt updated successfully');
        } else {
            showPromptStatus(result.error || 'Failed to save prompt', 'error');
        }
    } catch (error) {
        console.error('Error saving prompt:', error);
        showPromptStatus('Error saving prompt. Please try again.', 'error');
    } finally {
        savePromptBtn.disabled = false;
        savePromptBtn.textContent = 'üíæ Save Prompt';
        
        setTimeout(() => {
            hidePromptStatus();
        }, 5000);
    }
}
        // Single call functionality
        async function initiateCall() {
            const phoneNumber = phoneInput.value.trim();
            
            if (!phoneNumber) {
                showCallStatus('Please enter a phone number', 'error');
                return;
            }

            const phoneRegex = /^[\+]?[1-9][\d\s\-\(\)\.]{7,15}$/;
            if (!phoneRegex.test(phoneNumber)) {
                showCallStatus('Please enter a valid phone number', 'error');
                return;
            }

            try {
                callButton.disabled = true;
                callButton.textContent = 'üìû Initiating...';
                showCallStatus('Initiating call...', 'loading');

                const response = await fetch('/api/calls/initiate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ phoneNumber })
                });

                const result = await response.json();

                if (result.success) {
                    showCallStatus(`Call initiated successfully to ${phoneNumber}`, 'success');
                    phoneInput.value = '';
                    showNotification('Outbound call initiated successfully');
                    
                    setTimeout(() => {
                        refreshData();
                    }, 1000);
                } else {
                    showCallStatus(result.error || 'Failed to initiate call', 'error');
                }
            } catch (error) {
                console.error('Error initiating call:', error);
                showCallStatus('Error initiating call. Please try again.', 'error');
            } finally {
                callButton.disabled = false;
                callButton.textContent = 'üìû Start Call';
                
                setTimeout(() => {
                    hideCallStatus();
                }, 5000);
            }
        }

        // Prompt management functions
        async function loadCurrentPrompt() {
            try {
                showPromptStatus('Loading current prompt...', 'loading');
                const response = await fetch('/api/prompt');
                
                if (response.ok) {
                    const data = await response.json();
                    promptEditor.value = data.system_prompt || '';
                    currentPrompt = data.system_prompt || '';
                    showPromptStatus('Prompt loaded successfully', 'success');
                } else {
                    showPromptStatus('Failed to load current prompt', 'error');
                }
            } catch (error) {
                console.error('Error loading prompt:', error);
                showPromptStatus('Error loading prompt', 'error');
            } finally {
                setTimeout(() => {
                    hidePromptStatus();
                }, 3000);
            }
        }

        
        function loadTemplate(templateName) {
            if (promptTemplates[templateName]) {
                promptEditor.value = promptTemplates[templateName];
                showNotification(`${templateName.charAt(0).toUpperCase() + templateName.slice(1)} template loaded`);
            }
        }

        // Phone input formatting
        phoneInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            
            if (value.length >= 10) {
                if (value.length === 10) {
                    value = `(${value.substr(0, 3)}) ${value.substr(3, 3)}-${value.substr(6, 4)}`;
                } else if (value.length === 11 && value.charAt(0) === '1') {
                    value = `+1 (${value.substr(1, 3)}) ${value.substr(4, 3)}-${value.substr(7, 4)}`;
                }
            }
            
            e.target.value = value;
        });

        phoneInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                initiateCall();
            }
        });

        // Utility functions
        function showCallStatus(message, type) {
            callStatus.textContent = message;
            callStatus.className = `call-status ${type}`;
        }

        function hideCallStatus() {
            callStatus.className = 'call-status';
        }

        function showPromptStatus(message, type) {
            promptStatus.textContent = message;
            promptStatus.className = `prompt-status ${type}`;
        }

        function hidePromptStatus() {
            promptStatus.className = 'prompt-status';
        }

        function updateConnectionStatus(status, color) {
            connectionStatus.textContent = status;
            connectionStatus.style.color = color;
        }

        function renderCallHistory() {
            if (calls.length === 0) {
                callHistory.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìû</div>
                        <div class="empty-title">Waiting for calls</div>
                        <div class="empty-subtitle">Your live call data will appear here</div>
                        <div class="webhook-url">${window.location.origin}/webhook</div>
                    </div>
                `;
                return;
            }

            const callsToShow = calls.slice(0, config.maxCallsToShow);
            renderCardView(callsToShow);
            updateStats();
        }

        function renderCardView(callsToShow) {
            const cardsHTML = `
                <div class="call-cards">
                    ${callsToShow.map(call => `
                        <div class="call-card">
                            <div class="call-card-header">
                                <div class="call-phone">${formatPhoneNumber(call.caller_number || call.phone || 'Unknown')}</div>
                                <div class="call-datetime">
                                    <div class="call-date">${formatDate(call.timestamp)}</div>
                                    <div class="call-time">${formatTime(call.timestamp)}</div>
                                </div>
                            </div>
                            <div class="call-details">
                                <div class="call-duration">${formatDuration(call.duration)}</div>
                                <div class="call-type-badge call-type-${call.call_type || 'inbound'}">
                                    ${call.call_type === 'outbound' ? 'üì§ Out' : 'üì• In'}
                                </div>
                                <span class="status-badge status-${getStatusClass(call.status)}">
                                    ${call.status || 'Unknown'}
                                </span>
                            </div>
                            <div class="call-actions">
                                ${call.transcript ? 
                                    `<button class="transcript-btn" onclick="showTranscript('${call.id}')">View Transcript</button>` : 
                                    `<button class="transcript-btn" disabled>No Transcript</button>`
                                }
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            callHistory.innerHTML = cardsHTML;
        }

        function getStatusClass(status) {
            if (!status) return 'unknown';
            const statusLower = status.toLowerCase();
            if (statusLower.includes('complete') || statusLower === 'answered') return 'completed';
            if (statusLower.includes('fail') || statusLower === 'busy') return 'failed';
            if (statusLower.includes('initiat')) return 'initiated';
            return statusLower.replace(/[^a-z0-9]/g, '-');
        }

        function formatPhoneNumber(phone) {
            if (!phone || phone === 'Unknown') return phone;
            
            const cleaned = phone.replace(/\D/g, '');
            
            if (cleaned.length === 10) {
                return `(${cleaned.substr(0, 3)}) ${cleaned.substr(3, 3)}-${cleaned.substr(6, 4)}`;
            } else if (cleaned.length === 11 && cleaned.charAt(0) === '1') {
                return `+1 (${cleaned.substr(1, 3)}) ${cleaned.substr(4, 3)}-${cleaned.substr(7, 4)}`;
            }
            
            return phone;
        }

        function updateStats() {
            totalCalls.textContent = calls.length;
            
            const inboundCallCount = calls.filter(call => call.call_type !== 'outbound').length;
            inboundCalls.textContent = inboundCallCount;
            
            const callsWithTranscripts = calls.filter(call => 
                call.transcript && call.transcript.length > 0
            ).length;
            transcriptCount.textContent = callsWithTranscripts;
            
            lastUpdate.textContent = new Date().toLocaleTimeString();
        }

        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            const date = new Date(dateString);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (date.toDateString() === today.toDateString()) {
                return 'Today';
            } else if (date.toDateString() === yesterday.toDateString()) {
                return 'Yesterday';
            } else {
                return date.toLocaleDateString();
            }
        }

        function formatTime(dateString) {
            if (!dateString) return 'Unknown';
            return new Date(dateString).toLocaleTimeString([], {
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true
            });
        }

        function formatDuration(seconds) {
            if (!seconds || seconds === 0) return '0s';
            const hours = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}h ${mins}m`;
            } else if (mins > 0) {
                return `${mins}m ${secs}s`;
            } else {
                return `${secs}s`;
            }
        }

        function showNotification(message = 'New call received', isError = false) {
            notification.textContent = message;
            notification.className = `notification ${isError ? 'error' : ''}`;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        function showTranscript(callId) {
            const call = calls.find(c => c.id === callId);
            if (call && call.transcript) {
                const phoneNumber = formatPhoneNumber(call.caller_number || call.phone || 'Unknown');
                const callDate = formatDate(call.timestamp);
                const callTime = formatTime(call.timestamp);
                
                modalTitle.textContent = `Transcript - ${phoneNumber}`;
                
                const transcriptWithHeader = `Call Details:
Phone: ${phoneNumber}
Type: ${call.call_type === 'outbound' ? 'Outbound Call' : 'Inbound Call'}
Date: ${callDate} at ${callTime}
Duration: ${formatDuration(call.duration)}
Status: ${call.status || 'Unknown'}

Transcript:
${call.transcript}`;
                
                modalTranscript.textContent = transcriptWithHeader;
                transcriptModal.style.display = 'flex';
            }
        }

        function closeTranscriptModal() {
            transcriptModal.style.display = 'none';
        }

        function viewAllCalls() {
            config.maxCallsToShow = calls.length;
            renderCallHistory();
            
            const viewBtn = document.querySelector('button[onclick="viewAllCalls()"]');
            if (viewBtn) {
                const originalText = viewBtn.textContent;
                viewBtn.textContent = `‚úÖ Showing All ${calls.length}`;
                setTimeout(() => {
                    viewBtn.textContent = originalText;
                    config.maxCallsToShow = 10;
                }, 2000);
            }
        }

        async function refreshData() {
            try {
                const refreshBtn = document.querySelector('button[onclick="refreshData()"]');
                if (refreshBtn) {
                    refreshBtn.textContent = 'üîÑ Refreshing...';
                    refreshBtn.disabled = true;
                }
                
                const response = await fetch('/api/calls');
                if (response.ok) {
                    const data = await response.json();
                    calls = data.calls || [];
                    renderCallHistory();
                    updateStats();
                    showNotification('Data refreshed successfully');
                } else {
                    showNotification('Failed to refresh data', true);
                }
            } catch (error) {
                console.error('Error refreshing data:', error);
                showNotification('Error refreshing data', true);
            } finally {
                const refreshBtn = document.querySelector('button[onclick="refreshData()"]');
                if (refreshBtn) {
                    refreshBtn.textContent = 'Refresh Data';
                    refreshBtn.disabled = false;
                }
            }
        }

        // Close modal when clicking outside
        transcriptModal.addEventListener('click', (e) => {
            if (e.target === transcriptModal) {
                closeTranscriptModal();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && transcriptModal.style.display === 'flex') {
                closeTranscriptModal();
            }
            if (e.key === 'r' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                refreshData();
            }
        });

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            refreshData();
        });
    </script>
</body>
</html>
