<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkyIQ | AI Voice Solutions</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, system-ui, sans-serif;
            background: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .main-content {
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-bottom: 1px solid #e2e8f0;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.08);
            position: sticky;
            top: 0;
            z-index: 100;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1;
            min-width: 0;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }
        
        .logo-icon {
            width: 36px;
            height: 36px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:%234f46e5;stop-opacity:1" /><stop offset="100%" style="stop-color:%2306b6d4;stop-opacity:1" /></linearGradient></defs><path d="M20 25 Q20 15 30 15 L70 15 Q80 15 80 25 L80 45 Q80 55 70 55 L55 55 L50 65 L45 55 L30 55 Q20 55 20 45 Z" fill="url(%23grad1)" stroke="white" stroke-width="2"/><path d="M30 70 Q30 60 40 60 L75 60 Q85 60 85 70 L85 85 Q85 95 75 95 L40 95 Q30 95 30 85 Z" fill="url(%23grad1)" opacity="0.7"/><path d="M35 25 L75 25 M35 35 L65 35 M35 45 L70 45" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>') center/contain no-repeat;
            border-radius: 10px;
            filter: drop-shadow(0 2px 4px rgba(79, 70, 229, 0.2));
        }
        
        .logo-text {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #4f46e5, #06b6d4);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1e293b;
            letter-spacing: -0.025em;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .profile-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.75rem;
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.3);
        }
        
        .content-area {
            padding: 16px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 20px;
            margin-bottom: 20px;
            color: #15803d;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .calling-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
            background: white;
            padding: 4px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .tab-btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #64748b;
        }

        .tab-btn.active {
            background: #4f46e5;
            color: white;
            box-shadow: 0 2px 4px rgba(79, 70, 229, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
        
        .outbound-call-section {
            background: linear-gradient(135deg, #ffffff 0%, #fafbff 100%);
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
            margin-bottom: 24px;
            overflow: hidden;
        }
        
        .outbound-header {
            padding: 20px 16px;
            border-bottom: 1px solid #e2e8f0;
            background: linear-gradient(135deg, #fafbff 0%, #f1f5f9 100%);
        }
        
        .outbound-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 4px;
            color: #1e293b;
            letter-spacing: -0.025em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .outbound-subtitle {
            color: #64748b;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .outbound-form {
            padding: 20px 16px;
        }
        
        .phone-input-group {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        .phone-input {
            flex: 1;
            min-width: 250px;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            transition: all 0.2s ease;
            background: #ffffff;
        }
        
        .phone-input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .csv-upload-area {
            border: 2px dashed #e2e8f0;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            background: #f8fafc;
            margin-bottom: 16px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .csv-upload-area:hover {
            border-color: #4f46e5;
            background: #fafbff;
        }

        .csv-upload-area.dragover {
            border-color: #4f46e5;
            background: #f0f4ff;
        }

        .upload-icon {
            font-size: 2rem;
            margin-bottom: 8px;
            color: #64748b;
        }

        .upload-text {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .upload-subtitle {
            font-size: 0.875rem;
            color: #64748b;
        }

        .file-input {
            display: none;
        }

        .batch-name-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            margin-bottom: 16px;
            transition: all 0.2s ease;
        }

        .batch-name-input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .call-btn {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            min-height: 48px;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
            width: 100%;
            justify-content: center;
        }
        
        .call-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(79, 70, 229, 0.4);
        }
        
        .call-btn:active {
            transform: scale(0.98);
        }
        
        .call-btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .batch-status {
            padding: 16px;
            background: #f8fafc;
            border-radius: 8px;
            margin-top: 16px;
            display: none;
        }

        .batch-status.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 12px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4f46e5, #06b6d4);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .call-status {
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 0.875rem;
            font-weight: 500;
            display: none;
        }
        
        .call-status.success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
            display: block;
        }
        
        .call-status.error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
            display: block;
        }
        
        .call-status.loading {
            background: #dbeafe;
            color: #1d4ed8;
            border: 1px solid #bfdbfe;
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #fafbff 100%);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-align: center;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #4f46e5, #06b6d4);
        }
        
        .stat-card:active {
            transform: scale(0.98);
        }
        
        .stat-value {
            font-size: 2.25rem;
            font-weight: 800;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
            line-height: 1.1;
        }
        
        .stat-label {
            color: #64748b;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .controls {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            min-height: 44px;
            min-width: 100px;
        }
        
        .btn:active {
            transform: scale(0.95);
            background: #4338ca;
        }
        
        .btn.secondary {
            background: white;
            color: #64748b;
            border: 1px solid #e2e8f0;
        }
        
        .btn.secondary:active {
            background: #f8fafc;
            color: #334155;
        }
        
        .calls-section {
            background: linear-gradient(135deg, #ffffff 0%, #fafbff 100%);
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
            overflow: hidden;
        }
        
        .section-header {
            padding: 20px 16px;
            border-bottom: 1px solid #e2e8f0;
            background: linear-gradient(135deg, #fafbff 0%, #f1f5f9 100%);
        }
        
        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 4px;
            color: #1e293b;
            letter-spacing: -0.025em;
        }
        
        .section-subtitle {
            color: #64748b;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .call-cards {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .call-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .call-card:active {
            transform: scale(0.98);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .call-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            gap: 12px;
        }
        
        .call-phone {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 1.1rem;
            font-weight: 600;
            color: #4f46e5;
            flex-shrink: 0;
        }
        
        .call-datetime {
            text-align: right;
            font-size: 0.875rem;
            color: #64748b;
            line-height: 1.4;
        }
        
        .call-date {
            font-weight: 600;
        }
        
        .call-time {
            color: #94a3b8;
        }
        
        .call-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .call-duration {
            font-size: 0.875rem;
            color: #475569;
            font-weight: 500;
        }
        
        .call-type-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .call-type-inbound {
            background: #dbeafe;
            color: #1d4ed8;
        }
        
        .call-type-outbound {
            background: #f3e8ff;
            color: #7c3aed;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-completed {
            background: #dcfce7;
            color: #166534;
        }
        
        .status-failed {
            background: #fef2f2;
            color: #dc2626;
        }
        
        .status-initiated {
            background: #e0f2fe;
            color: #0369a1;
        }
        
        .call-actions {
            display: flex;
            justify-content: flex-end;
        }
        
        .transcript-btn {
            background: none;
            border: 1px solid #e2e8f0;
            color: #4f46e5;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 36px;
        }
        
        .transcript-btn:active {
            background: #f8fafc;
            border-color: #4f46e5;
        }
        
        .transcript-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }
        
        .empty-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .empty-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: #475569;
        }
        
        .empty-subtitle {
            margin-bottom: 24px;
        }
        
        .webhook-url {
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px 16px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 0.75rem;
            color: #4f46e5;
            word-break: break-all;
            max-width: 100%;
            margin: 0 auto;
        }
        
        .notification {
            position: fixed;
            top: 24px;
            right: 24px;
            background: #22c55e;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            font-weight: 500;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            background: #dc2626;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }
        
        .transcript-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 20px;
            max-width: calc(100vw - 32px);
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 16px;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
            flex: 1;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
            padding: 8px;
            min-height: 44px;
            min-width: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            flex-shrink: 0;
        }
        
        .close-btn:active {
            background: #f1f5f9;
        }
        
        .transcript-content {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            font-family: system-ui, -apple-system, sans-serif;
            font-size: 0.875rem;
            line-height: 1.6;
            white-space: pre-wrap;
            color: #475569;
            max-height: 60vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Media Queries */
        @media (min-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 20px;
            }
            
            .content-area {
                padding: 24px;
            }
            
            .header {
                padding: 20px 32px;
            }
            
            .logo-icon {
                width: 44px;
                height: 44px;
            }
            
            .logo-text {
                font-size: 1.75rem;
            }
            
            .header-title {
                font-size: 1.5rem;
            }
            
            .profile-avatar {
                width: 36px;
                height: 36px;
                font-size: 0.875rem;
            }
            
            .phone-input-group {
                flex-wrap: nowrap;
            }
        }
        
        @media (max-width: 480px) {
            .header {
                flex-direction: column;
                align-items: stretch;
                gap: 16px;
                padding: 16px;
            }
            
            .header-left {
                justify-content: center;
            }
            
            .user-profile {
                justify-content: center;
            }
            
            .logo-text {
                font-size: 1.25rem;
            }
            
            .header-title {
                font-size: 1rem;
                text-align: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                padding: 14px 16px;
            }
            
            .phone-input-group {
                flex-direction: column;
            }
            
            .phone-input {
                min-width: 100%;
            }
            
            .calling-tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="main-content">
        <div class="header">
            <div class="header-left">
                <div class="logo">
                    <div class="logo-icon"></div>
                    <div class="logo-text" id="appName">SkyIQ</div>
                </div>
                <div class="header-title" id="companyName">Sales Dashboard</div>
            </div>
            <div class="user-profile">
                <div class="profile-avatar" id="userInitials">--</div>
            </div>
        </div>

        <div class="content-area">
            <div class="connection-status">
                <div class="status-dot"></div>
                <span id="connectionStatus">Connected</span>
            </div>

            <!-- Calling Tabs -->
            <div class="calling-tabs">
                <button class="tab-btn active" onclick="switchTab('single')">📞 Single Call</button>
                <button class="tab-btn" onclick="switchTab('batch')">📁 Batch Calls</button>
            </div>

            <!-- Single Call Tab -->
            <div id="singleTab" class="tab-content active">
                <div class="outbound-call-section">
                    <div class="outbound-header">
                        <div class="outbound-title">
                            📞 Single Outbound Call
                        </div>
                        <div class="outbound-subtitle">Make individual calls directly from your dashboard</div>
                    </div>
                    <div class="outbound-form">
                        <div class="phone-input-group">
                            <input 
                                type="tel" 
                                id="phoneInput" 
                                class="phone-input" 
                                placeholder="Enter phone number (e.g., +1-555-123-4567)"
                                maxlength="20"
                            >
                            <button id="callButton" class="call-btn" onclick="initiateCall()">
                                📞 Start Call
                            </button>
                        </div>
                        <div id="callStatus" class="call-status"></div>
                    </div>
                </div>
            </div>

            <!-- Batch Call Tab -->
            <div id="batchTab" class="tab-content">
                <div class="outbound-call-section">
                    <div class="outbound-header">
                        <div class="outbound-title">
                            📁 Batch Outbound Calls
                        </div>
                        <div class="outbound-subtitle">Upload CSV file and call multiple numbers sequentially</div>
                    </div>
                    <div class="outbound-form">
                        <input 
                            type="text" 
                            id="batchNameInput" 
                            class="batch-name-input" 
                            placeholder="Campaign name (e.g., 'Q4 Sales Outreach')"
                        >
                        
                        <div class="csv-upload-area" id="csvUploadArea" onclick="document.getElementById('csvFileInput').click()">
                            <div class="upload-icon">📄</div>
                            <div class="upload-text">Click to upload CSV file</div>
                            <div class="upload-subtitle">or drag and drop your file here</div>
                            <div class="upload-subtitle" style="margin-top: 8px; font-size: 0.75rem;">
                                Format: One phone number per line or use header "phone_number"
                            </div>
                        </div>
                        
                        <input 
                            type="file" 
                            id="csvFileInput" 
                            class="file-input" 
                            accept=".csv,.txt"
                            onchange="handleFileSelect(this.files[0])"
                        >
                        
                        <button id="batchCallButton" class="call-btn" onclick="startBatch()" disabled>
                            📁 Start Batch Calling
                        </button>
                        
                        <div id="batchStatus" class="batch-status">
                            <div id="batchProgress"></div>
                            <div class="progress-bar">
                                <div id="progressFill" class="progress-fill"></div>
                            </div>
                            <div id="batchStats"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalCalls">0</div>
                    <div class="stat-label">Total Calls</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="outboundCalls">0</div>
                    <div class="stat-label">Outbound Calls</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="transcriptCount">0</div>
                    <div class="stat-label">With Transcripts</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="lastUpdate">Never</div>
                    <div class="stat-label">Last Update</div>
                </div>
            </div>

            <div class="controls">
                <button class="btn" onclick="refreshData()">Refresh Data</button>
                <button class="btn secondary" onclick="viewAllCalls()">View All Calls</button>
            </div>

            <div class="calls-section">
                <div class="section-header">
                    <div class="section-title">Call Log</div>
                    <div class="section-subtitle">Recent conversation monitoring and analysis</div>
                </div>
                
                <div id="callHistory">
                    <div class="empty-state">
                        <div class="empty-icon">📞</div>
                        <div class="empty-title">Waiting for calls</div>
                        <div class="empty-subtitle">Your live call data will appear here</div>
                        <div class="webhook-url" id="webhookUrl">Loading webhook URL...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="transcriptModal" class="transcript-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Call Transcript</div>
                <button class="close-btn" onclick="closeTranscriptModal()">&times;</button>
            </div>
            <div class="transcript-content" id="modalTranscript">
                No transcript available
            </div>
        </div>
    </div>

    <div id="notification" class="notification">
        New call received
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Configuration object
        const config = {
            appName: 'SkyIQ',
            companyName: 'Sales Dashboard',
            userInitials: 'RP',
            maxCallsToShow: 20,
            autoRefreshInterval: 30000,
            socketEnabled: true
        };

        // Global variables
        let calls = [];
        let batches = [];
        let currentBatch = null;
        let selectedFile = null;

        // Socket connection
        let socket;
        if (config.socketEnabled && typeof io !== 'undefined') {
            socket = io();
            
            socket.on('connect', () => {
                updateConnectionStatus('Connected', '#22c55e');
            });

            socket.on('disconnect', () => {
                updateConnectionStatus('Disconnected', '#dc2626');
            });

            socket.on('callHistory', (history) => {
                calls = history;
                renderCallHistory();
            });

            socket.on('batchHistory', (batchHistory) => {
                batches = batchHistory;
            });

            socket.on('newCall', (callData) => {
                calls.unshift(callData);
                renderCallHistory();
                showNotification(`${callData.call_type === 'outbound' ? 'Outbound' : 'New'} call ${callData.call_type === 'outbound' ? 'initiated' : 'received'}`);
                updateStats();
            });

            socket.on('updateCall', (callData) => {
                const index = calls.findIndex(call => call.id === callData.id);
                if (index >= 0) {
                    calls[index] = callData;
                    renderCallHistory();
                    updateStats();
                }
            });

            socket.on('batchProgress', (data) => {
                updateBatchProgress(data);
            });

            socket.on('batchCompleted', (data) => {
                completeBatch(data);
            });
        }

        // DOM elements
        const callHistory = document.getElementById('callHistory');
        const totalCalls = document.getElementById('totalCalls');
        const outboundCalls = document.getElementById('outboundCalls');
        const transcriptCount = document.getElementById('transcriptCount');
        const lastUpdate = document.getElementById('lastUpdate');
        const connectionStatus = document.getElementById('connectionStatus');
        const notification = document.getElementById('notification');
        const transcriptModal = document.getElementById('transcriptModal');
        const modalTranscript = document.getElementById('modalTranscript');
        const modalTitle = document.getElementById('modalTitle');
        const phoneInput = document.getElementById('phoneInput');
        const callButton = document.getElementById('callButton');
        const callStatus = document.getElementById('callStatus');

        // Batch calling elements
        const csvUploadArea = document.getElementById('csvUploadArea');
        const csvFileInput = document.getElementById('csvFileInput');
        const batchNameInput = document.getElementById('batchNameInput');
        const batchCallButton = document.getElementById('batchCallButton');
        const batchStatus = document.getElementById('batchStatus');

        // Initialize app
        function initializeApp() {
            document.getElementById('appName').textContent = config.appName;
            document.getElementById('companyName').textContent = config.companyName;
            document.getElementById('userInitials').textContent = config.userInitials;
            
            const webhookUrl = document.getElementById('webhookUrl');
            webhookUrl.textContent = `${window.location.origin}/webhook`;
            
            updateStats();
        }

        // Tab switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // Single call functionality
        async function initiateCall() {
            const phoneNumber = phoneInput.value.trim();
            
            if (!phoneNumber) {
                showCallStatus('Please enter a phone number', 'error');
                return;
            }

            const phoneRegex = /^[\+]?[1-9][\d\s\-\(\)\.]{7,15}$/;
            if (!phoneRegex.test(phoneNumber)) {
                showCallStatus('Please enter a valid phone number', 'error');
                return;
            }

            try {
                callButton.disabled = true;
                callButton.textContent = '📞 Initiating...';
                showCallStatus('Initiating call...', 'loading');

                const response = await fetch('/api/calls/initiate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ phoneNumber })
                });

                const result = await response.json();

                if (result.success) {
                    showCallStatus(`Call initiated successfully to ${phoneNumber}`, 'success');
                    phoneInput.value = '';
                    showNotification('Outbound call initiated successfully');
                    
                    setTimeout(() => {
                        refreshData();
                    }, 1000);
                } else {
                    showCallStatus(result.error || 'Failed to initiate call', 'error');
                }
            } catch (error) {
                console.error('Error initiating call:', error);
                showCallStatus('Error initiating call. Please try again.', 'error');
            } finally {
                callButton.disabled = false;
                callButton.textContent = '📞 Start Call';
                
                setTimeout(() => {
                    hideCallStatus();
                }, 5000);
            }
        }

        // Batch calling functionality
        function handleFileSelect(file) {
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.csv') && !file.name.toLowerCase().endsWith('.txt')) {
                showNotification('Please select a CSV or TXT file', true);
                return;
            }

            selectedFile = file;
            csvUploadArea.innerHTML = `
                <div class="upload-icon">✅</div>
                <div class="upload-text">${file.name}</div>
                <div class="upload-subtitle">Ready to upload ${Math.round(file.size / 1024)}KB</div>
            `;

            batchCallButton.disabled = false;
        }

        // Drag and drop functionality
        csvUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            csvUploadArea.classList.add('dragover');
        });

        csvUploadArea.addEventListener('dragleave', () => {
            csvUploadArea.classList.remove('dragover');
        });

        csvUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            csvUploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });

        async function startBatch() {
            if (!selectedFile) {
                showNotification('Please select a CSV file first', true);
                return;
            }

            try {
                batchCallButton.disabled = true;
                batchCallButton.textContent = '📁 Uploading...';

                const formData = new FormData();
                formData.append('csvFile', selectedFile);
                formData.append('batchName', batchNameInput.value || `Batch ${new Date().toLocaleDateString()}`);

                const response = await fetch('/api/batch/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(`Batch created: ${result.totalCalls} numbers`);
                    currentBatch = result.batchId;
                    
                    // Start the batch
                    const startResponse = await fetch(`/api/batch/${result.batchId}/start`, {
                        method: 'POST'
                    });

                    const startResult = await startResponse.json();
                    
                    if (startResult.success) {
                        showNotification('Batch calling started!');
                        batchStatus.classList.add('active');
                        document.getElementById('batchProgress').textContent = 'Starting batch calls...';
                        
                        // Reset form
                        selectedFile = null;
                        batchNameInput.value = '';
                        resetUploadArea();
                    }
                } else {
                    showNotification(result.error || 'Failed to create batch', true);
                }
            } catch (error) {
                console.error('Error starting batch:', error);
                showNotification('Error starting batch calls', true);
            } finally {
                batchCallButton.disabled = false;
                batchCallButton.textContent = '📁 Start Batch Calling';
            }
        }

        function resetUploadArea() {
            csvUploadArea.innerHTML = `
                <div class="upload-icon">📄</div>
                <div class="upload-text">Click to upload CSV file</div>
                <div class="upload-subtitle">or drag and drop your file here</div>
                <div class="upload-subtitle" style="margin-top: 8px; font-size: 0.75rem;">
                    Format: One phone number per line or use header "phone_number"
                </div>
            `;
            batchCallButton.disabled = true;
        }

        function updateBatchProgress(data) {
            const progress = data.progress;
            const percentage = Math.round((progress.completed_calls / progress.total_calls) * 100);
            
            document.getElementById('batchProgress').textContent = 
                `Calling ${data.currentCall} (${progress.completed_calls}/${progress.total_calls})`;
            
            document.getElementById('progressFill').style.width = `${percentage}%`;
            
            document.getElementById('batchStats').innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.875rem;">
                    <span>✅ Success: ${progress.successful_calls}</span>
                    <span>❌ Failed: ${progress.failed_calls}</span>
                    <span>📊 ${percentage}% Complete</span>
                </div>
            `;
        }

        function completeBatch(data) {
            const progress = data.progress;
            document.getElementById('batchProgress').textContent = 
                `Batch completed! ${progress.successful_calls} successful, ${progress.failed_calls} failed`;
            
            showNotification(`Batch completed: ${progress.successful_calls}/${progress.total_calls} calls successful`);
            
            setTimeout(() => {
                batchStatus.classList.remove('active');
                refreshData();
            }, 5000);
        }

        // Phone input formatting
        phoneInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            
            if (value.length >= 10) {
                if (value.length === 10) {
                    value = `(${value.substr(0, 3)}) ${value.substr(3, 3)}-${value.substr(6, 4)}`;
                } else if (value.length === 11 && value.charAt(0) === '1') {
                    value = `+1 (${value.substr(1, 3)}) ${value.substr(4, 3)}-${value.substr(7, 4)}`;
                }
            }
            
            e.target.value = value;
        });

        phoneInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                initiateCall();
            }
        });

        // Utility functions
        function showCallStatus(message, type) {
            callStatus.textContent = message;
            callStatus.className = `call-status ${type}`;
        }

        function hideCallStatus() {
            callStatus.className = 'call-status';
        }

        function updateConnectionStatus(status, color) {
            connectionStatus.textContent = status;
            connectionStatus.style.color = color;
        }

        function renderCallHistory() {
            if (calls.length === 0) {
                callHistory.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📞</div>
                        <div class="empty-title">Waiting for calls</div>
                        <div class="empty-subtitle">Your live call data will appear here</div>
                        <div class="webhook-url">${window.location.origin}/webhook</div>
                    </div>
                `;
                return;
            }

            const callsToShow = calls.slice(0, config.maxCallsToShow);
            renderCardView(callsToShow);
            updateStats();
        }

        function renderCardView(callsToShow) {
            const cardsHTML = `
                <div class="call-cards">
                    ${callsToShow.map(call => `
                        <div class="call-card">
                            <div class="call-card-header">
                                <div class="call-phone">${formatPhoneNumber(call.caller_number || call.phone || 'Unknown')}</div>
                                <div class="call-datetime">
                                    <div class="call-date">${formatDate(call.timestamp)}</div>
                                    <div class="call-time">${formatTime(call.timestamp)}</div>
                                </div>
                            </div>
                            <div class="call-details">
                                <div class="call-duration">Duration: ${formatDuration(call.duration)}</div>
                                <div class="call-type-badge call-type-${call.call_type || 'inbound'}">
                                    ${call.call_type === 'outbound' ? '📤 Outbound' : '📥 Inbound'}
                                </div>
                                <span class="status-badge status-${getStatusClass(call.status)}">
                                    ${call.status || 'Unknown'}
                                </span>
                            </div>
                            <div class="call-actions">
                                ${call.transcript ? 
                                    `<button class="transcript-btn" onclick="showTranscript('${call.id}')">View Transcript</button>` : 
                                    `<button class="transcript-btn" disabled>No Transcript</button>`
                                }
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            callHistory.innerHTML = cardsHTML;
        }

        function getStatusClass(status) {
            if (!status) return 'unknown';
            const statusLower = status.toLowerCase();
            if (statusLower.includes('complete') || statusLower === 'answered') return 'completed';
            if (statusLower.includes('fail') || statusLower === 'busy') return 'failed';
            if (statusLower.includes('initiat')) return 'initiated';
            return statusLower.replace(/[^a-z0-9]/g, '-');
        }

        function formatPhoneNumber(phone) {
            if (!phone || phone === 'Unknown') return phone;
            
            const cleaned = phone.replace(/\D/g, '');
            
            if (cleaned.length === 10) {
                return `(${cleaned.substr(0, 3)}) ${cleaned.substr(3, 3)}-${cleaned.substr(6, 4)}`;
            } else if (cleaned.length === 11 && cleaned.charAt(0) === '1') {
                return `+1 (${cleaned.substr(1, 3)}) ${cleaned.substr(4, 3)}-${cleaned.substr(7, 4)}`;
            }
            
            return phone;
        }

        function updateStats() {
            totalCalls.textContent = calls.length;
            
            const outboundCallCount = calls.filter(call => call.call_type === 'outbound').length;
            outboundCalls.textContent = outboundCallCount;
            
            const callsWithTranscripts = calls.filter(call => 
                call.transcript && call.transcript.length > 0
            ).length;
            transcriptCount.textContent = callsWithTranscripts;
            
            lastUpdate.textContent = new Date().toLocaleTimeString();
        }

        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            const date = new Date(dateString);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (date.toDateString() === today.toDateString()) {
                return 'Today';
            } else if (date.toDateString() === yesterday.toDateString()) {
                return 'Yesterday';
            } else {
                return date.toLocaleDateString();
            }
        }

        function formatTime(dateString) {
            if (!dateString) return 'Unknown';
            return new Date(dateString).toLocaleTimeString([], {
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true
            });
        }

        function formatDuration(seconds) {
            if (!seconds || seconds === 0) return '0m 0s';
            const hours = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}h ${mins}m ${secs}s`;
            } else {
                return `${mins}m ${secs}s`;
            }
        }

        function showNotification(message = 'New call received', isError = false) {
            notification.textContent = message;
            notification.className = `notification ${isError ? 'error' : ''}`;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        function showTranscript(callId) {
            const call = calls.find(c => c.id === callId);
            if (call && call.transcript) {
                const phoneNumber = formatPhoneNumber(call.caller_number || call.phone || 'Unknown');
                const callDate = formatDate(call.timestamp);
                const callTime = formatTime(call.timestamp);
                
                modalTitle.textContent = `Transcript - ${phoneNumber}`;
                
                const transcriptWithHeader = `Call Details:
Phone: ${phoneNumber}
Type: ${call.call_type === 'outbound' ? 'Outbound Call' : 'Inbound Call'}
Date: ${callDate} at ${callTime}
Duration: ${formatDuration(call.duration)}
Status: ${call.status || 'Unknown'}

Transcript:
${call.transcript}`;
                
                modalTranscript.textContent = transcriptWithHeader;
                transcriptModal.style.display = 'flex';
            }
        }

        function closeTranscriptModal() {
            transcriptModal.style.display = 'none';
        }

        function viewAllCalls() {
            config.maxCallsToShow = calls.length;
            renderCallHistory();
            
            const viewBtn = document.querySelector('button[onclick="viewAllCalls()"]');
            if (viewBtn) {
                const originalText = viewBtn.textContent;
                viewBtn.textContent = `✅ Showing All ${calls.length}`;
                setTimeout(() => {
                    viewBtn.textContent = originalText;
                    config.maxCallsToShow = 20;
                }, 2000);
            }
        }

        async function refreshData() {
            try {
                const refreshBtn = document.querySelector('button[onclick="refreshData()"]');
                if (refreshBtn) {
                    refreshBtn.textContent = '🔄 Refreshing...';
                    refreshBtn.disabled = true;
                }
                
                const response = await fetch('/api/calls');
                if (response.ok) {
                    const data = await response.json();
                    calls = data.calls || [];
                    renderCallHistory();
                    updateStats();
                    showNotification('Data refreshed successfully');
                } else {
                    showNotification('Failed to refresh data', true);
                }
            } catch (error) {
                console.error('Error refreshing data:', error);
                showNotification('Error refreshing data', true);
            } finally {
                const refreshBtn = document.querySelector('button[onclick="refreshData()"]');
                if (refreshBtn) {
                    refreshBtn.textContent = 'Refresh Data';
                    refreshBtn.disabled = false;
                }
            }
        }

        // Close modal when clicking outside
        transcriptModal.addEventListener('click', (e) => {
            if (e.target === transcriptModal) {
                closeTranscriptModal();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && transcriptModal.style.display === 'flex') {
                closeTranscriptModal();
            }
            if (e.key === 'r' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                refreshData();
            }
        });

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            refreshData();
        });
    </script>
</body>
</html>
