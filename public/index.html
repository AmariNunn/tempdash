<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkyIQ | AI Voice Solutions</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, system-ui, sans-serif;
            background: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
        }
        
        .main-content {
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-bottom: 1px solid #e2e8f0;
            padding: 20px 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.08);
            position: relative;
        }
        
        .header-center {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo-icon {
            width: 44px;
            height: 44px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:%234f46e5;stop-opacity:1" /><stop offset="100%" style="stop-color:%2306b6d4;stop-opacity:1" /></linearGradient></defs><path d="M20 25 Q20 15 30 15 L70 15 Q80 15 80 25 L80 45 Q80 55 70 55 L55 55 L50 65 L45 55 L30 55 Q20 55 20 45 Z" fill="url(%23grad1)" stroke="white" stroke-width="2"/><path d="M30 70 Q30 60 40 60 L75 60 Q85 60 85 70 L85 85 Q85 95 75 95 L40 95 Q30 95 30 85 Z" fill="url(%23grad1)" opacity="0.7"/><path d="M35 25 L75 25 M35 35 L65 35 M35 45 L70 45" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>') center/contain no-repeat;
            border-radius: 12px;
            filter: drop-shadow(0 2px 4px rgba(79, 70, 229, 0.2));
        }
        
        .logo-text {
            font-size: 1.75rem;
            font-weight: 800;
            background: linear-gradient(135deg, #4f46e5, #06b6d4);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header-divider {
            width: 2px;
            height: 32px;
            background: linear-gradient(to bottom, transparent, #e2e8f0, transparent);
            margin: 0 8px;
        }
        
        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e293b;
            letter-spacing: -0.025em;
        }
        
        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .user-profile {
            position: absolute;
            right: 40px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .profile-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.3);
        }
        
        .content-area {
            padding: 32px;
            max-width: 1400px;
        }
        
        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 20px;
            margin-bottom: 32px;
            color: #15803d;
            font-size: 0.875rem;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #fafbff 100%);
            padding: 28px;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #4f46e5, #06b6d4);
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .stat-value {
            font-size: 2.25rem;
            font-weight: 800;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
            line-height: 1.1;
        }
        
        .stat-label {
            color: #64748b;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .controls {
            display: flex;
            gap: 12px;
            justify-content: flex-start;
            margin-bottom: 32px;
            flex-wrap: wrap;
        }
        
        .btn {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        
        .btn:hover {
            background: #4338ca;
            transform: translateY(-1px);
        }
        
        .btn.secondary {
            background: white;
            color: #64748b;
            border: 1px solid #e2e8f0;
        }
        
        .btn.secondary:hover {
            background: #f8fafc;
            color: #334155;
        }
        
        .btn.danger {
            background: #dc2626;
        }
        
        .btn.danger:hover {
            background: #b91c1c;
        }
        
        .calls-section {
            background: linear-gradient(135deg, #ffffff 0%, #fafbff 100%);
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
            overflow: hidden;
        }
        
        .section-header {
            padding: 28px 32px;
            border-bottom: 1px solid #e2e8f0;
            background: linear-gradient(135deg, #fafbff 0%, #f1f5f9 100%);
        }
        
        .section-title {
            font-size: 1.375rem;
            font-weight: 700;
            margin-bottom: 6px;
            color: #1e293b;
            letter-spacing: -0.025em;
        }
        
        .section-subtitle {
            color: #64748b;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .call-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .call-table th {
            background: #f8fafc;
            padding: 12px 24px;
            text-align: left;
            font-weight: 500;
            font-size: 0.875rem;
            color: #475569;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .call-table td {
            padding: 16px 24px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.875rem;
        }
        
        .call-table tr:hover {
            background: #f8fafc;
        }
        
        .phone-number {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            color: #4f46e5;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-completed {
            background: #dcfce7;
            color: #166534;
        }
        
        .status-failed {
            background: #fef2f2;
            color: #dc2626;
        }
        
        .status-missed {
            background: #fef3c7;
            color: #d97706;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }
        
        .empty-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .empty-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: #475569;
        }
        
        .empty-subtitle {
            margin-bottom: 24px;
        }
        
        .webhook-url {
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px 16px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 0.75rem;
            color: #4f46e5;
            word-break: break-all;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .notification {
            position: fixed;
            top: 24px;
            right: 24px;
            background: #22c55e;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            font-weight: 500;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .transcript-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 32px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
            padding: 4px;
        }
        
        .transcript-content {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 0.875rem;
            line-height: 1.6;
            white-space: pre-wrap;
            color: #475569;
            max-height: 400px;
            overflow-y: auto;
        }
        
        @media (max-width: 640px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .call-table {
                font-size: 0.75rem;
            }
            
            .call-table th,
            .call-table td {
                padding: 8px 12px;
            }
            
            .header {
                padding: 16px 20px;
            }
            
            .header-center {
                flex-direction: column;
                gap: 12px;
                text-align: center;
            }
            
            .header-divider {
                display: none;
            }
            
            .user-profile {
                position: static;
                margin-top: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <div class="header-center">
                <div class="logo">
                    <div class="logo-icon"></div>
                    <div class="logo-text">SkyIQ</div>
                </div>
                <div class="header-divider"></div>
                <div class="header-title">Rhow Properties Dashboard</div>
            </div>
            <div class="user-profile">
                <div class="profile-avatar">RP</div>
            </div>
        </div>

        <div class="content-area">
            <div class="connection-status">
                <div class="status-dot"></div>
                <span id="connectionStatus">Connected</span>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalCalls">0</div>
                    <div class="stat-label">Total Calls</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="transcriptCount">0</div>
                    <div class="stat-label">With Transcripts</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="lastUpdate">Never</div>
                    <div class="stat-label">Last Update</div>
                </div>
            </div>

            <div class="controls">
                <button class="btn" onclick="refreshData()">Refresh Data</button>
                <button class="btn secondary" onclick="viewAllCalls()">View All Calls</button>
                <button class="btn danger" onclick="clearHistory()">Clear History</button>
            </div>

            <div class="calls-section">
                <div class="section-header">
                    <div class="section-title">Call Log</div>
                    <div class="section-subtitle">Recent conversation monitoring and analysis</div>
                </div>
                
                <div id="callHistory">
                    <div class="empty-state">
                        <div class="empty-icon">📞</div>
                        <div class="empty-title">Waiting for calls</div>
                        <div class="empty-subtitle">Your live call data will appear here</div>
                        <div class="webhook-url" id="webhookUrl">Loading webhook URL...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transcript Modal -->
    <div id="transcriptModal" class="transcript-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Call Transcript</div>
                <button class="close-btn" onclick="closeTranscriptModal()">&times;</button>
            </div>
            <div class="transcript-content" id="modalTranscript">
                No transcript available
            </div>
        </div>
    </div>

    <div id="notification" class="notification">
        New call received
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let calls = [];

        // DOM elements
        const callHistory = document.getElementById('callHistory');
        const totalCalls = document.getElementById('totalCalls');
        const transcriptCount = document.getElementById('transcriptCount');
        const lastUpdate = document.getElementById('lastUpdate');
        const connectionStatus = document.getElementById('connectionStatus');
        const notification = document.getElementById('notification');
        const webhookUrl = document.getElementById('webhookUrl');
        const transcriptModal = document.getElementById('transcriptModal');
        const modalTranscript = document.getElementById('modalTranscript');

        // Set webhook URL
        webhookUrl.textContent = `${window.location.origin}/webhook`;

        // Socket event listeners
        socket.on('connect', () => {
            connectionStatus.textContent = 'Connected';
            connectionStatus.style.color = '#22c55e';
        });

        socket.on('disconnect', () => {
            connectionStatus.textContent = 'Disconnected';
            connectionStatus.style.color = '#dc2626';
        });

        socket.on('callHistory', (history) => {
            calls = history;
            console.log('Received call history:', calls.length, 'calls');
            renderCallHistory();
        });

        socket.on('newCall', (callData) => {
            console.log('New call received:', callData);
            calls.unshift(callData);
            renderCallHistory();
            showNotification();
            updateStats();
        });

        socket.on('updateCall', (callData) => {
            const index = calls.findIndex(call => call.id === callData.id);
            if (index >= 0) {
                calls[index] = callData;
                renderCallHistory();
                updateStats();
            }
        });

        function renderCallHistory() {
            if (calls.length === 0) {
                callHistory.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📞</div>
                        <div class="empty-title">Waiting for calls</div>
                        <div class="empty-subtitle">Your live call data will appear here</div>
                        <div class="webhook-url">${window.location.origin}/webhook</div>
                    </div>
                `;
                return;
            }

            const tableHTML = `
                <table class="call-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Phone Number</th>
                            <th>Duration</th>
                            <th>Status</th>
                            <th>Transcript</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${calls.slice(0, 10).map(call => `
                            <tr>
                                <td>${formatDate(call.timestamp).split(' ')[0]}</td>
                                <td>${formatTime(call.timestamp)}</td>
                                <td class="phone-number">${call.caller_number}</td>
                                <td>${formatDuration(call.duration)}</td>
                                <td>
                                    <span class="status-badge status-${call.status}">
                                        ${call.status}
                                    </span>
                                </td>
                                <td>
                                    ${call.transcript ? 
                                        `<button class="btn secondary" style="padding: 4px 8px; font-size: 0.75rem;" onclick="showTranscript('${call.id}')">View</button>` : 
                                        '<span style="color: #94a3b8;">No transcript</span>'
                                    }
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            callHistory.innerHTML = tableHTML;
            updateStats();
        }

        function updateStats() {
            totalCalls.textContent = calls.length;
            
            const callsWithTranscripts = calls.filter(call => call.transcript && call.transcript.length > 0).length;
            transcriptCount.textContent = callsWithTranscripts;
            
            lastUpdate.textContent = new Date().toLocaleTimeString();
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString();
        }

        function formatTime(dateString) {
            return new Date(dateString).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function formatDuration(seconds) {
            if (!seconds || seconds === 0) return '0m 0s';
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}m ${secs}s`;
        }

        function showNotification() {
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function showTranscript(callId) {
            const call = calls.find(c => c.id === callId);
            if (call && call.transcript) {
                modalTranscript.textContent = call.transcript;
                transcriptModal.style.display = 'flex';
            }
        }

        function closeTranscriptModal() {
            transcriptModal.style.display = 'none';
        }

        function viewAllCalls() {
            // Show all calls instead of just first 10
            renderCallHistory();
        }

        async function refreshData() {
            try {
                console.log('Manual refresh - fetching data...');
                const response = await fetch('/api/calls');
                const data = await response.json();
                calls = data.calls;
                console.log('Fetched', calls.length, 'calls from API');
                renderCallHistory();
                updateStats();
                
                const refreshBtn = document.querySelector('button[onclick="refreshData()"]');
                if (refreshBtn) {
                    const originalText = refreshBtn.textContent;
                    refreshBtn.textContent = '✅ Refreshed';
                    setTimeout(() => {
                        refreshBtn.textContent = originalText;
                    }, 1000);
                }
            } catch (error) {
                console.error('Error refreshing data:', error);
            }
        }

        function clearHistory() {
            if (confirm('Are you sure you want to clear all call history?')) {
                calls = [];
                renderCallHistory();
                updateStats();
            }
        }

        // Close modal when clicking outside
        transcriptModal.addEventListener('click', (e) => {
            if (e.target === transcriptModal) {
                closeTranscriptModal();
            }
        });

        // Initialize
        updateStats();
    </script>
</body>
</html>
