<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkyIQ | AI Voice Solutions</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, system-ui, sans-serif;
            background: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .main-content {
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-bottom: 1px solid #e2e8f0;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.08);
            position: sticky;
            top: 0;
            z-index: 100;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1;
            min-width: 0;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }
        
        .logo-icon {
            width: 36px;
            height: 36px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:%234f46e5;stop-opacity:1" /><stop offset="100%" style="stop-color:%2306b6d4;stop-opacity:1" /></linearGradient></defs><path d="M20 25 Q20 15 30 15 L70 15 Q80 15 80 25 L80 45 Q80 55 70 55 L55 55 L50 65 L45 55 L30 55 Q20 55 20 45 Z" fill="url(%23grad1)" stroke="white" stroke-width="2"/><path d="M30 70 Q30 60 40 60 L75 60 Q85 60 85 70 L85 85 Q85 95 75 95 L40 95 Q30 95 30 85 Z" fill="url(%23grad1)" opacity="0.7"/><path d="M35 25 L75 25 M35 35 L65 35 M35 45 L70 45" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>') center/contain no-repeat;
            border-radius: 10px;
            filter: drop-shadow(0 2px 4px rgba(79, 70, 229, 0.2));
        }
        
        .logo-text {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #4f46e5, #06b6d4);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1e293b;
            letter-spacing: -0.025em;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .profile-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.75rem;
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.3);
        }
        
        .content-area {
            padding: 16px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 20px;
            margin-bottom: 20px;
            color: #15803d;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #fafbff 100%);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-align: center;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #4f46e5, #06b6d4);
        }
        
        .stat-card:active {
            transform: scale(0.98);
        }
        
        .stat-value {
            font-size: 2.25rem;
            font-weight: 800;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
            line-height: 1.1;
        }
        
        .stat-label {
            color: #64748b;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .controls {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            min-height: 44px;
            min-width: 100px;
        }
        
        .btn:active {
            transform: scale(0.95);
            background: #4338ca;
        }
        
        .btn.secondary {
            background: white;
            color: #64748b;
            border: 1px solid #e2e8f0;
        }
        
        .btn.secondary:active {
            background: #f8fafc;
            color: #334155;
        }
        
        .btn.danger {
            background: #dc2626;
        }
        
        .btn.danger:active {
            background: #b91c1c;
        }
        
        .calls-section {
            background: linear-gradient(135deg, #ffffff 0%, #fafbff 100%);
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
            overflow: hidden;
        }
        
        .section-header {
            padding: 20px 16px;
            border-bottom: 1px solid #e2e8f0;
            background: linear-gradient(135deg, #fafbff 0%, #f1f5f9 100%);
        }
        
        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 4px;
            color: #1e293b;
            letter-spacing: -0.025em;
        }
        
        .section-subtitle {
            color: #64748b;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        /* Mobile-First Call Cards */
        .call-cards {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .call-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .call-card:active {
            transform: scale(0.98);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .call-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            gap: 12px;
        }
        
        .call-phone {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 1.1rem;
            font-weight: 600;
            color: #4f46e5;
            flex-shrink: 0;
        }
        
        .call-datetime {
            text-align: right;
            font-size: 0.875rem;
            color: #64748b;
            line-height: 1.4;
        }
        
        .call-date {
            font-weight: 600;
        }
        
        .call-time {
            color: #94a3b8;
        }
        
        .call-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .call-duration {
            font-size: 0.875rem;
            color: #475569;
            font-weight: 500;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-completed {
            background: #dcfce7;
            color: #166534;
        }
        
        .status-failed {
            background: #fef2f2;
            color: #dc2626;
        }
        
        .status-missed {
            background: #fef3c7;
            color: #d97706;
        }
        
        .status-in-progress {
            background: #dbeafe;
            color: #1d4ed8;
        }
        
        .call-actions {
            display: flex;
            justify-content: flex-end;
        }
        
        .transcript-btn {
            background: none;
            border: 1px solid #e2e8f0;
            color: #4f46e5;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 36px;
        }
        
        .transcript-btn:active {
            background: #f8fafc;
            border-color: #4f46e5;
        }
        
        .transcript-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Desktop Table (hidden on mobile) */
        .call-table-container {
            display: none;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .call-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 700px;
        }
        
        .call-table th {
            background: #f8fafc;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 0.875rem;
            color: #475569;
            border-bottom: 1px solid #e2e8f0;
            white-space: nowrap;
        }
        
        .call-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.875rem;
            white-space: nowrap;
        }
        
        .call-table tr:active {
            background: #f8fafc;
        }
        
        .phone-number {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            color: #4f46e5;
            font-weight: 600;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }
        
        .empty-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .empty-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: #475569;
        }
        
        .empty-subtitle {
            margin-bottom: 24px;
        }
        
        .webhook-url {
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px 16px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 0.75rem;
            color: #4f46e5;
            word-break: break-all;
            max-width: 100%;
            margin: 0 auto;
        }
        
        .notification {
            position: fixed;
            top: 24px;
            right: 24px;
            background: #22c55e;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            font-weight: 500;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .transcript-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 20px;
            max-width: calc(100vw - 32px);
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 16px;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
            flex: 1;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
            padding: 8px;
            min-height: 44px;
            min-width: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            flex-shrink: 0;
        }
        
        .close-btn:active {
            background: #f1f5f9;
        }
        
        .transcript-content {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            font-family: system-ui, -apple-system, sans-serif;
            font-size: 0.875rem;
            line-height: 1.6;
            white-space: pre-wrap;
            color: #475569;
            max-height: 60vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .view-toggle {
            display: none;
            gap: 4px;
            margin-bottom: 16px;
            justify-content: center;
        }
        
        .toggle-btn {
            padding: 8px 16px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .toggle-btn.active {
            background: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
        
        .toggle-btn:active {
            transform: scale(0.95);
        }
        
        /* Media Queries */
        @media (min-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 20px;
            }
            
            .content-area {
                padding: 24px;
            }
            
            .header {
                padding: 20px 32px;
            }
            
            .logo-icon {
                width: 44px;
                height: 44px;
            }
            
            .logo-text {
                font-size: 1.75rem;
            }
            
            .header-title {
                font-size: 1.5rem;
            }
            
            .profile-avatar {
                width: 36px;
                height: 36px;
                font-size: 0.875rem;
            }
            
            .view-toggle {
                display: flex;
            }
            
            .call-cards {
                display: none;
            }
            
            .call-table-container {
                display: block;
            }
        }
        
        @media (max-width: 480px) {
            .header {
                flex-direction: column;
                align-items: stretch;
                gap: 16px;
                padding: 16px;
            }
            
            .header-left {
                justify-content: center;
            }
            
            .user-profile {
                justify-content: center;
            }
            
            .logo-text {
                font-size: 1.25rem;
            }
            
            .header-title {
                font-size: 1rem;
                text-align: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                padding: 14px 16px;
            }
            
            .call-card-header {
                flex-direction: column;
                gap: 8px;
                text-align: left;
            }
            
            .call-datetime {
                text-align: left;
            }
            
            .modal-content {
                padding: 16px;
                margin: 8px;
                border-radius: 12px;
            }
            
            .modal-title {
                font-size: 1.125rem;
            }
        }
    </style>
</head>
<body>
    <div class="main-content">
        <div class="header">
            <div class="header-left">
                <div class="logo">
                    <div class="logo-icon"></div>
                    <div class="logo-text" id="appName">SkyIQ</div>
                </div>
                <div class="header-title" id="companyName">Dashboard</div>
            </div>
            <div class="user-profile">
                <div class="profile-avatar" id="userInitials">--</div>
            </div>
        </div>

        <div class="content-area">
            <div class="connection-status">
                <div class="status-dot"></div>
                <span id="connectionStatus">Connected</span>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalCalls">0</div>
                    <div class="stat-label">Total Calls</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="transcriptCount">0</div>
                    <div class="stat-label">With Transcripts</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="lastUpdate">Never</div>
                    <div class="stat-label">Last Update</div>
                </div>
            </div>

            <div class="controls">
                <button class="btn" onclick="refreshData()">Refresh Data</button>
                <button class="btn secondary" onclick="viewAllCalls()">View All Calls</button>
                
            </div>

            <div class="calls-section">
                <div class="section-header">
                    <div class="section-title">Call Log</div>
                    <div class="section-subtitle">Recent conversation monitoring and analysis</div>
                </div>
                
                <div class="view-toggle">
                    <button class="toggle-btn" onclick="switchView('cards')">Cards</button>
                    <button class="toggle-btn active" onclick="switchView('table')">Table</button>
                </div>
                
                <div id="callHistory">
                    <div class="empty-state">
                        <div class="empty-icon">ðŸ“ž</div>
                        <div class="empty-title">Waiting for calls</div>
                        <div class="empty-subtitle">Your live call data will appear here</div>
                        <div class="webhook-url" id="webhookUrl">Loading webhook URL...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="transcriptModal" class="transcript-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Call Transcript</div>
                <button class="close-btn" onclick="closeTranscriptModal()">&times;</button>
            </div>
            <div class="transcript-content" id="modalTranscript">
                No transcript available
            </div>
        </div>
    </div>

    <div id="notification" class="notification">
        New call received
    </div>

    <script>
        // Configuration object - easy to modify
        const config = {
            appName: 'SkyIQ',
            companyName: 'Dashboard',
            userInitials: 'RP',
            maxCallsToShow: 20,
            autoRefreshInterval: 30000, // 30 seconds
            socketEnabled: true
        };

        // Initialize app with config
        function initializeApp() {
            document.getElementById('appName').textContent = config.appName;
            document.getElementById('companyName').textContent = config.companyName;
            document.getElementById('userInitials').textContent = config.userInitials;
            
            const webhookUrl = document.getElementById('webhookUrl');
            webhookUrl.textContent = `${window.location.origin}/webhook`;
            
            updateStats();
        }

        // Socket connection (if enabled)
        let socket;
        if (config.socketEnabled && typeof io !== 'undefined') {
            socket = io();
            
            socket.on('connect', () => {
                updateConnectionStatus('Connected', '#22c55e');
            });

            socket.on('disconnect', () => {
                updateConnectionStatus('Disconnected', '#dc2626');
            });

            socket.on('callHistory', (history) => {
                calls = history;
                console.log('Received call history:', calls.length, 'calls');
                renderCallHistory();
            });

            socket.on('newCall', (callData) => {
                console.log('New call received:', callData);
                calls.unshift(callData);
                renderCallHistory();
                showNotification('New call received');
                updateStats();
            });

            socket.on('updateCall', (callData) => {
                const index = calls.findIndex(call => call.id === callData.id);
                if (index >= 0) {
                    calls[index] = callData;
                    renderCallHistory();
                    updateStats();
                }
            });
        }

        let calls = [];
        let currentView = 'table';

        // DOM elements
        const callHistory = document.getElementById('callHistory');
        const totalCalls = document.getElementById('totalCalls');
        const transcriptCount = document.getElementById('transcriptCount');
        const lastUpdate = document.getElementById('lastUpdate');
        const connectionStatus = document.getElementById('connectionStatus');
        const notification = document.getElementById('notification');
        const transcriptModal = document.getElementById('transcriptModal');
        const modalTranscript = document.getElementById('modalTranscript');
        const modalTitle = document.getElementById('modalTitle');

        function updateConnectionStatus(status, color) {
            connectionStatus.textContent = status;
            connectionStatus.style.color = color;
        }

        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            renderCallHistory();
        }

        function renderCallHistory() {
            if (calls.length === 0) {
                callHistory.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ðŸ“ž</div>
                        <div class="empty-title">Waiting for calls</div>
                        <div class="empty-subtitle">Your live call data will appear here</div>
                        <div class="webhook-url">${window.location.origin}/webhook</div>
                    </div>
                `;
                return;
            }

            const callsToShow = calls.slice(0, config.maxCallsToShow);

            if (currentView === 'cards' || window.innerWidth < 768) {
                renderCardView(callsToShow);
            } else {
                renderTableView(callsToShow);
            }

            updateStats();
        }

        function renderCardView(callsToShow) {
            const cardsHTML = `
                <div class="call-cards">
                    ${callsToShow.map(call => `
                        <div class="call-card">
                            <div class="call-card-header">
                                <div class="call-phone">${formatPhoneNumber(call.caller_number || call.phone || 'Unknown')}</div>
                                <div class="call-datetime">
                                    <div class="call-date">${formatDate(call.timestamp)}</div>
                                    <div class="call-time">${formatTime(call.timestamp)}</div>
                                </div>
                            </div>
                            <div class="call-details">
                                <div class="call-duration">Duration: ${formatDuration(call.duration)}</div>
                                <span class="status-badge status-${getStatusClass(call.status)}">
                                    ${call.status || 'Unknown'}
                                </span>
                            </div>
                            <div class="call-actions">
                                ${call.transcript ? 
                                    `<button class="transcript-btn" onclick="showTranscript('${call.id}')">View Transcript</button>` : 
                                    `<button class="transcript-btn" disabled>No Transcript</button>`
                                }
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            callHistory.innerHTML = cardsHTML;
        }

        function renderTableView(callsToShow) {
            const tableHTML = `
                <div class="call-table-container">
                    <table class="call-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Phone Number</th>
                                <th>Duration</th>
                                <th>Status</th>
                                <th>Transcript</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${callsToShow.map(call => `
                                <tr>
                                    <td>${formatDate(call.timestamp)}</td>
                                    <td>${formatTime(call.timestamp)}</td>
                                    <td class="phone-number">${formatPhoneNumber(call.caller_number || call.phone || 'Unknown')}</td>
                                    <td>${formatDuration(call.duration)}</td>
                                    <td>
                                        <span class="status-badge status-${getStatusClass(call.status)}">
                                            ${call.status || 'Unknown'}
                                        </span>
                                    </td>
                                    <td>
                                        ${call.transcript ? 
                                            `<button class="btn secondary" style="padding: 6px 12px; font-size: 0.75rem; min-height: 32px;" onclick="showTranscript('${call.id}')">View</button>` : 
                                            '<span style="color: #94a3b8;">â€”</span>'
                                        }
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            callHistory.innerHTML = tableHTML;
        }

        function getStatusClass(status) {
            if (!status) return 'unknown';
            const statusLower = status.toLowerCase();
            if (statusLower.includes('complete') || statusLower === 'answered') return 'completed';
            if (statusLower.includes('fail') || statusLower === 'busy') return 'failed';
            if (statusLower.includes('miss') || statusLower === 'no-answer') return 'missed';
            if (statusLower.includes('progress') || statusLower === 'ringing') return 'in-progress';
            return statusLower.replace(/[^a-z0-9]/g, '-');
        }

        function formatPhoneNumber(phone) {
            if (!phone || phone === 'Unknown') return phone;
            
            // Remove all non-digit characters
            const cleaned = phone.replace(/\D/g, '');
            
            // Format US phone numbers
            if (cleaned.length === 10) {
                return `(${cleaned.substr(0, 3)}) ${cleaned.substr(3, 3)}-${cleaned.substr(6, 4)}`;
            } else if (cleaned.length === 11 && cleaned.charAt(0) === '1') {
                return `+1 (${cleaned.substr(1, 3)}) ${cleaned.substr(4, 3)}-${cleaned.substr(7, 4)}`;
            }
            
            // Return original if can't format
            return phone;
        }

        function updateStats() {
            totalCalls.textContent = calls.length;
            
            const callsWithTranscripts = calls.filter(call => 
                call.transcript && call.transcript.length > 0
            ).length;
            transcriptCount.textContent = callsWithTranscripts;
            
            lastUpdate.textContent = new Date().toLocaleTimeString();
        }

        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            const date = new Date(dateString);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (date.toDateString() === today.toDateString()) {
                return 'Today';
            } else if (date.toDateString() === yesterday.toDateString()) {
                return 'Yesterday';
            } else {
                return date.toLocaleDateString();
            }
        }

        function formatTime(dateString) {
            if (!dateString) return 'Unknown';
            return new Date(dateString).toLocaleTimeString([], {
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true
            });
        }

        function formatDuration(seconds) {
            if (!seconds || seconds === 0) return '0m 0s';
            const hours = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}h ${mins}m ${secs}s`;
            } else {
                return `${mins}m ${secs}s`;
            }
        }

        function showNotification(message = 'New call received') {
            notification.textContent = message;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function showTranscript(callId) {
            const call = calls.find(c => c.id === callId);
            if (call && call.transcript) {
                const phoneNumber = formatPhoneNumber(call.caller_number || call.phone || 'Unknown');
                const callDate = formatDate(call.timestamp);
                const callTime = formatTime(call.timestamp);
                
                modalTitle.textContent = `Transcript - ${phoneNumber}`;
                modalTranscript.textContent = call.transcript;
                transcriptModal.style.display = 'flex';
                
                // Add call details to transcript
                const transcriptWithHeader = `Call Details:
Phone: ${phoneNumber}
Date: ${callDate} at ${callTime}
Duration: ${formatDuration(call.duration)}
Status: ${call.status || 'Unknown'}

Transcript:
${call.transcript}`;
                
                modalTranscript.textContent = transcriptWithHeader;
            }
        }

        function closeTranscriptModal() {
            transcriptModal.style.display = 'none';
        }

        function viewAllCalls() {
            config.maxCallsToShow = calls.length;
            renderCallHistory();
            
            const viewBtn = document.querySelector('button[onclick="viewAllCalls()"]');
            if (viewBtn) {
                const originalText = viewBtn.textContent;
                viewBtn.textContent = `âœ… Showing All ${calls.length}`;
                setTimeout(() => {
                    viewBtn.textContent = originalText;
                    config.maxCallsToShow = 20; // Reset to default
                }, 2000);
            }
        }

        async function refreshData() {
            try {
                console.log('Manual refresh - fetching data...');
                
                // Show loading state
                const refreshBtn = document.querySelector('button[onclick="refreshData()"]');
                if (refreshBtn) {
                    refreshBtn.textContent = 'ðŸ”„ Refreshing...';
                    refreshBtn.disabled = true;
                }
                
                const response = await fetch('/api/calls');
                if (response.ok) {
                    const data = await response.json();
                    calls = data.calls || [];
                    console.log('Fetched', calls.length, 'calls from API');
                    renderCallHistory();
                    updateStats();
                    showNotification('Data refreshed successfully');
                } else {
                    console.error('Failed to fetch calls:', response.statusText);
                    showNotification('Failed to refresh data');
                }
            } catch (error) {
                console.error('Error refreshing data:', error);
                showNotification('Error refreshing data');
                
                // Fallback: generate sample data for demo
                generateSampleData();
            } finally {
                // Reset button
                const refreshBtn = document.querySelector('button[onclick="refreshData()"]');
                if (refreshBtn) {
                    refreshBtn.textContent = 'Refresh Data';
                    refreshBtn.disabled = false;
                }
            }
        }

        function clearHistory() {
            if (confirm('Are you sure you want to clear all call history?')) {
                calls = [];
                renderCallHistory();
                updateStats();
                showNotification('Call history cleared');
            }
        }

        // Generate sample data for demonstration
        function generateSampleData() {
            const sampleCalls = [
                {
                    id: '1',
                    caller_number: '+1-555-0123',
                    timestamp: new Date().toISOString(),
                    duration: 180,
                    status: 'completed',
                    transcript: 'Hello, I\'m calling about the property listing on Oak Street. Is it still available? I\'d like to schedule a viewing if possible.'
                },
                {
                    id: '2',
                    caller_number: '(555) 456-7890',
                    timestamp: new Date(Date.now() - 3600000).toISOString(),
                    duration: 45,
                    status: 'missed',
                    transcript: null
                },
                {
                    id: '3',
                    caller_number: '555.789.0123',
                    timestamp: new Date(Date.now() - 7200000).toISOString(),
                    duration: 320,
                    status: 'completed',
                    transcript: 'Hi, I saw your property advertisement online. Can you tell me more about the neighborhood? What are the schools like in the area?'
                },
                {
                    id: '4',
                    caller_number: '15551234567',
                    timestamp: new Date(Date.now() - 86400000).toISOString(),
                    duration: 0,
                    status: 'failed',
                    transcript: null
                }
            ];
            
            calls = sampleCalls;
            renderCallHistory();
            updateStats();
            console.log('Generated sample data for demonstration');
        }

        // Auto-refresh functionality
        let autoRefreshTimer;
        
        function startAutoRefresh() {
            if (config.autoRefreshInterval > 0) {
                autoRefreshTimer = setInterval(() => {
                    if (!document.hidden) { // Only refresh if page is visible
                        refreshData();
                    }
                }, config.autoRefreshInterval);
            }
        }

        function stopAutoRefresh() {
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
            }
        }

        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                startAutoRefresh();
            }
        });

        // Close modal when clicking outside
        transcriptModal.addEventListener('click', (e) => {
            if (e.target === transcriptModal) {
                closeTranscriptModal();
            }
        });

        // Handle window resize
        window.addEventListener('resize', () => {
            renderCallHistory();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && transcriptModal.style.display === 'flex') {
                closeTranscriptModal();
            }
            if (e.key === 'r' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                refreshData();
            }
        });

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            refreshData();
            startAutoRefresh();
        });

        // Export configuration for easy modification
        window.dashboardConfig = config;
        
        // Utility function to update configuration
        window.updateConfig = function(newConfig) {
            Object.assign(config, newConfig);
            initializeApp();
            renderCallHistory();
        };
    </script>
</body>
</html>
